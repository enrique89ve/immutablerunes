---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/svelte/Header.svelte";
import PixelBackground from "@/components/svelte/PixelBackground.svelte";
---

<Layout title="Subir imagen | Immutable Runes">
  <Header client:load />

  <main class="relative min-h-[calc(100vh-4rem)] bg-bg">
    <!-- Animated pixel background -->
    <PixelBackground username="upload" density={25} client:load />

    <div class="relative mx-auto max-w-2xl px-4 py-8 sm:py-12">
      <!-- Page header -->
      <div class="mb-6 sm:mb-8 text-center">
        <div class="inline-flex items-center justify-center w-14 h-14 sm:w-16 sm:h-16 rounded-full bg-accent/10 border border-accent/30 mb-4">
          <svg class="w-7 h-7 sm:w-8 sm:h-8 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </div>
        <h1 class="mb-3 font-mono text-2xl sm:text-3xl font-bold tracking-tight uppercase text-text">
          Subir imagen
        </h1>
        <p class="text-text/60 font-mono text-sm max-w-md mx-auto">
          Tu pixel art quedará guardado permanentemente en Hive
        </p>
      </div>

      <!-- Auth check -->
      <div
        id="auth-required"
        class="flex min-h-[300px] sm:min-h-[350px] flex-col items-center justify-center border border-dashed border-text/20 rounded-lg bg-subtle/30"
      >
        <div class="w-16 h-16 rounded-full bg-text/5 flex items-center justify-center mb-4">
          <svg
            class="text-text/40 h-8 w-8"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
          </svg>
        </div>
        <p class="text-text/60 mb-3 font-mono text-sm text-center px-4">
          Conecta tu cuenta para subir imágenes
        </p>
        <p class="text-text/40 font-mono text-xs text-center px-4">
          Usa el botón <span class="text-accent font-semibold">Conectar</span> en la parte superior
        </p>
      </div>

      <!-- Upload interface (hidden until logged in) -->
      <div id="upload-interface" class="hidden">
        <!-- Drop zone -->
        <div
          id="drop-zone"
          class="group relative flex min-h-[250px] sm:min-h-[300px] cursor-pointer flex-col items-center justify-center border-2 border-dashed border-text/20 hover:border-accent/60 rounded-lg bg-subtle/20 transition-all duration-300"
          role="button"
          tabindex="0"
          aria-label="Área para subir imagen. Arrastra un archivo o haz clic para seleccionar"
        >
          <input
            type="file"
            id="file-input"
            accept="image/png,image/jpeg,image/webp"
            class="absolute inset-0 cursor-pointer opacity-0"
            aria-describedby="file-formats"
          />
          <div class="w-14 h-14 rounded-full bg-text/5 group-hover:bg-accent/10 flex items-center justify-center mb-4 transition-colors">
            <svg
              class="text-text/40 group-hover:text-accent h-7 w-7 transition-colors"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="17 8 12 3 7 8"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
          </div>
          <p class="text-text/60 group-hover:text-text mb-2 font-mono text-sm text-center px-4 transition-colors">
            Arrastra una imagen o toca para seleccionar
          </p>
          <p id="file-formats" class="text-text/40 font-mono text-xs">
            PNG, JPEG, WebP
          </p>
        </div>

        <!-- Loading state with pixel animation -->
        <div id="loading-container" class="hidden">
          <div class="flex flex-col items-center justify-center min-h-[300px] border border-text/10 rounded-lg bg-subtle/30 p-6">
            <!-- Pixel loader animation -->
            <div class="pixel-loader mb-6">
              <div class="pixel-grid">
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
                <div class="pixel"></div>
              </div>
            </div>
            <p class="text-text/80 font-mono text-sm mb-1">Procesando imagen...</p>
            <p class="text-text/40 font-mono text-xs">Optimizando para blockchain</p>
          </div>
        </div>

        <!-- Error message -->
        <div id="error-container" class="hidden">
          <div class="border border-accent/30 bg-accent/5 rounded-lg p-5 text-center">
            <div class="w-12 h-12 rounded-full bg-accent/10 flex items-center justify-center mx-auto mb-4">
              <svg class="w-6 h-6 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
            </div>
            <p id="error-message" class="text-accent font-mono text-sm mb-4"></p>
            <button
              id="retry-btn"
              class="inline-flex items-center gap-2 px-4 py-2 border border-accent/30 text-accent font-mono text-xs uppercase tracking-wider rounded hover:bg-accent/10 transition-colors"
              type="button"
            >
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
              Intentar de nuevo
            </button>
          </div>
        </div>

        <!-- Preview (hidden until image processed) -->
        <div id="preview-container" class="hidden">
          <div class="relative border-2 border-accent/20 rounded-lg overflow-hidden bg-bg-elevated shadow-[0_0_60px_rgba(238,52,74,0.08)]">
            <!-- Corner decorations - outer container -->
            <div class="absolute top-3 left-3 w-5 h-5 border-l-2 border-t-2 border-accent/50 pointer-events-none z-10"></div>
            <div class="absolute top-3 right-3 w-5 h-5 border-r-2 border-t-2 border-accent/50 pointer-events-none z-10"></div>
            <div class="absolute bottom-3 left-3 w-5 h-5 border-l-2 border-b-2 border-accent/50 pointer-events-none z-10"></div>
            <div class="absolute bottom-3 right-3 w-5 h-5 border-r-2 border-b-2 border-accent/50 pointer-events-none z-10"></div>

            <!-- Image display area - large centered display -->
            <div class="relative flex items-center justify-center p-6 sm:p-8 md:p-10 bg-bg-deep min-h-[280px] sm:min-h-[340px]">
              <!-- Grid pattern background -->
              <div class="pointer-events-none absolute inset-0 opacity-20" style="background-image: linear-gradient(rgba(238,52,74,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(238,52,74,0.1) 1px, transparent 1px); background-size: 20px 20px;"></div>

              <!-- Scanline overlay -->
              <div class="pointer-events-none absolute inset-0 bg-[repeating-linear-gradient(0deg,transparent,transparent_3px,rgba(255,255,255,0.015)_3px,rgba(255,255,255,0.015)_6px)]"></div>

              <!-- Image wrapper with zoom button -->
              <button
                id="preview-zoom-btn"
                class="group relative cursor-zoom-in focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-4 focus-visible:ring-offset-black rounded-sm"
                type="button"
                aria-label="Ampliar imagen para ver en tamaño completo"
              >
                <!-- Glow effect behind image -->
                <div class="absolute -inset-4 bg-accent/10 blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

                <div
                  id="preview-wrapper"
                  class="relative border-2 border-white/10 bg-black shadow-[0_0_40px_rgba(0,0,0,0.5),0_0_80px_rgba(238,52,74,0.1)] transition-all duration-300 group-hover:border-accent/50 group-hover:shadow-[0_0_60px_rgba(238,52,74,0.25)]"
                >
                  <img
                    id="preview-image"
                    src=""
                    alt="Vista previa de tu imagen"
                    class="pixelated block"
                  />
                </div>

                <!-- Zoom indicator overlay -->
                <div class="absolute inset-0 flex items-center justify-center bg-black/0 transition-all duration-300 group-hover:bg-black/60 rounded-sm">
                  <div class="flex flex-col items-center opacity-0 scale-90 group-hover:opacity-100 group-hover:scale-100 transition-all duration-200">
                    <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-full bg-accent/20 backdrop-blur-sm border border-accent/40 flex items-center justify-center mb-2">
                      <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35M11 8v6M8 11h6"></path>
                      </svg>
                    </div>
                    <span class="text-white font-mono text-[10px] uppercase tracking-widest">Ampliar</span>
                  </div>
                </div>
              </button>
            </div>

            <!-- Image info grid -->
            <div class="border-t border-white/10 px-4 py-4 sm:px-6 sm:py-5 bg-black/40">
              <!-- Filename header -->
              <p id="file-name" class="font-mono text-sm text-white/90 truncate mb-4 pb-3 border-b border-white/10"></p>

              <!-- Stats grid - 2x2 on mobile, 4 columns on desktop -->
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
                <!-- Dimensions -->
                <div class="bg-white/5 rounded-md p-3 border border-white/5">
                  <p class="font-mono text-[10px] uppercase tracking-wider text-white/40 mb-1">Dimensiones</p>
                  <p id="dimensions" class="font-mono text-sm text-white/80"></p>
                </div>
                <!-- Size -->
                <div class="bg-white/5 rounded-md p-3 border border-white/5">
                  <p class="font-mono text-[10px] uppercase tracking-wider text-white/40 mb-1">Tamaño</p>
                  <p id="file-size" class="font-mono text-sm text-white/80"></p>
                </div>
                <!-- Fragments -->
                <div class="bg-white/5 rounded-md p-3 border border-white/5">
                  <p class="font-mono text-[10px] uppercase tracking-wider text-white/40 mb-1">Fragmentos</p>
                  <p id="fragment-count" class="font-mono text-sm text-accent"></p>
                </div>
                <!-- Aspect Ratio -->
                <div class="bg-white/5 rounded-md p-3 border border-white/5">
                  <p class="font-mono text-[10px] uppercase tracking-wider text-white/40 mb-1">Proporción</p>
                  <p id="aspect-ratio" class="font-mono text-sm text-white/80"></p>
                </div>
              </div>
            </div>

            <!-- Action buttons - Mobile first: full width stacked -->
            <div class="border-t border-white/10 p-4 sm:p-5 bg-black/30">
              <div class="flex flex-col sm:flex-row gap-3">
                <!-- Upload button (primary action - first on mobile) -->
                <button
                  id="upload-btn"
                  type="button"
                  class="flex-1 px-6 py-4 font-mono text-sm uppercase tracking-wider text-white bg-accent hover:bg-accent/90 active:bg-accent/80 transition-all disabled:opacity-40 disabled:cursor-not-allowed focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 focus-visible:ring-offset-black rounded-md shadow-[0_0_20px_rgba(238,52,74,0.2)] hover:shadow-[0_0_30px_rgba(238,52,74,0.4)]"
                  aria-label="Guardar imagen en la blockchain de Hive"
                >
                  <span class="flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 640 640" fill="currentColor">
                      <path d="M324.4 318.9L195.5 97.1C195.3 96.8 195 96.5 194.7 96.3C194.4 96.1 194 96 193.6 96C193.2 96 192.8 96.1 192.5 96.3C192.2 96.5 191.9 96.8 191.7 97.1L64.3 318.9C64.1 319.2 64 319.6 64 320C64 320.4 64.1 320.8 64.3 321.1L193.1 542.9C193.3 543.2 193.6 543.5 193.9 543.7C194.2 543.9 194.6 544 195 544C195.4 544 195.8 543.9 196.1 543.7C196.4 543.5 196.7 543.2 196.9 542.9L324.4 321.1C324.6 320.8 324.7 320.4 324.7 320C324.7 319.6 324.6 319.2 324.4 318.9zM363.5 293.2C363.7 293.5 364 293.8 364.3 294C364.6 294.2 365 294.3 365.4 294.3L431.9 294.3C432.3 294.3 432.7 294.2 433 294C433.3 293.8 433.6 293.5 433.8 293.2C434 292.9 434.1 292.5 434.1 292.1C434.1 291.7 434 291.3 433.8 291L323.1 97.1C322.9 96.8 322.6 96.5 322.3 96.3C322 96.1 321.6 96 321.2 96L254.7 96C254.3 96 253.9 96.1 253.6 96.3C253.3 96.5 253 96.8 252.8 97.1C252.6 97.4 252.5 97.8 252.5 98.2C252.5 98.6 252.6 99 252.8 99.3L363.4 293.2zM575.8 318.9L448.9 97.1C448.7 96.8 448.4 96.5 448.1 96.3C447.8 96.1 447.4 96 447 96L380.4 96C380 96 379.6 96.1 379.3 96.3C379 96.5 378.7 96.8 378.5 97.1C378.3 97.4 378.2 97.8 378.2 98.2C378.2 98.6 378.3 99 378.5 99.3L504.7 320L378.5 540.7C378.3 541 378.2 541.4 378.2 541.8C378.2 542.2 378.3 542.6 378.5 542.9C378.7 543.2 379 543.5 379.3 543.7C379.6 543.9 380 544 380.4 544L447 544C447.4 544 447.8 543.9 448.1 543.7C448.4 543.5 448.7 543.2 448.9 542.9L575.7 321.1C575.9 320.8 576 320.4 576 320C576 319.6 575.9 319.2 575.7 318.9zM430 348.9L363.5 348.9C363.1 348.9 362.7 349 362.4 349.2C362.1 349.4 361.8 349.7 361.6 350L252.8 540.7C252.6 541 252.5 541.4 252.5 541.8C252.5 542.2 252.6 542.6 252.8 542.9C253 543.2 253.3 543.5 253.6 543.7C253.9 543.9 254.3 544 254.7 544L321.2 544C321.6 544 322 543.9 322.3 543.7C322.6 543.5 322.9 543.2 323.1 542.9L431.9 352.3C432.1 352 432.2 351.6 432.2 351.2C432.2 350.8 432.1 350.4 431.9 350.1C431.7 349.8 431.4 349.5 431.1 349.3C430.8 349.1 430.4 349 430 349z"/>
                    </svg>
                    Guardar en Hive
                  </span>
                </button>
                <!-- Cancel button -->
                <button
                  id="cancel-btn"
                  type="button"
                  class="sm:w-auto px-6 py-4 font-mono text-sm uppercase tracking-wider text-white/60 hover:text-white bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 transition-all focus:outline-none focus-visible:ring-2 focus-visible:ring-white/50 rounded-md"
                  aria-label="Cancelar y seleccionar otra imagen"
                >
                  <span class="flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M18 6L6 18M6 6l12 12"></path>
                    </svg>
                    Cancelar
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Image zoom modal -->
        <div id="image-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
          <div id="modal-backdrop" class="absolute inset-0 bg-black/95 backdrop-blur-md"></div>
          <div class="absolute inset-0 flex items-center justify-center p-4">
            <!-- Close button -->
            <button
              id="modal-close-btn"
              class="absolute top-4 right-4 z-10 w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center text-text/60 hover:text-text bg-black/50 rounded-full transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-text/50"
              aria-label="Cerrar vista ampliada"
              type="button"
            >
              <svg class="w-6 h-6 sm:w-8 sm:h-8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"></path>
              </svg>
            </button>

            <!-- Modal image container with aspect ratio preservation -->
            <div class="relative flex items-center justify-center">
              <h2 id="modal-title" class="sr-only">Vista ampliada de la imagen</h2>
              <div id="modal-image-wrapper" class="relative border-2 border-text/20 shadow-[0_0_80px_rgba(238,52,74,0.15)]">
                <img
                  id="modal-image"
                  src=""
                  alt="Imagen ampliada"
                  class="pixelated block"
                />
              </div>
              <!-- Image info overlay -->
              <div class="absolute -bottom-8 left-0 right-0 text-center">
                <p id="modal-dimensions" class="font-mono text-xs text-text/50"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Upload progress with pixel animation -->
        <div id="progress-container" class="hidden">
          <div class="border border-text/10 rounded-lg overflow-hidden bg-subtle/30">
            <!-- Pixel animation header -->
            <div class="relative flex items-center justify-center py-8 bg-bg-surface">
              <!-- Animated pixel loader -->
              <div class="upload-pixel-loader">
                <div class="upload-pixel-grid">
                  <div class="upload-pixel" style="--delay: 0"></div>
                  <div class="upload-pixel" style="--delay: 1"></div>
                  <div class="upload-pixel" style="--delay: 2"></div>
                  <div class="upload-pixel" style="--delay: 3"></div>
                  <div class="upload-pixel" style="--delay: 4"></div>
                  <div class="upload-pixel" style="--delay: 5"></div>
                  <div class="upload-pixel" style="--delay: 6"></div>
                  <div class="upload-pixel" style="--delay: 7"></div>
                  <div class="upload-pixel" style="--delay: 8"></div>
                </div>
              </div>
            </div>

            <!-- Progress info -->
            <div class="p-4 sm:p-6">
              <div class="mb-3 flex items-center justify-between">
                <p class="font-mono text-sm text-text">Guardando en blockchain...</p>
                <p id="progress-text" class="text-accent font-mono text-sm font-semibold">0/0</p>
              </div>

              <!-- Progress bar -->
              <div class="relative h-2 w-full bg-text/10 rounded-full overflow-hidden">
                <div
                  id="progress-bar"
                  class="absolute inset-y-0 left-0 bg-accent transition-all duration-500 ease-out rounded-full"
                  style="width: 0%"
                  role="progressbar"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                ></div>
                <!-- Animated glow -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></div>
              </div>

              <p id="progress-status" class="text-text/50 mt-3 font-mono text-xs"></p>
            </div>
          </div>
        </div>

        <!-- Success message with celebration -->
        <div id="success-container" class="hidden">
          <div class="border border-green-500/30 bg-green-500/5 rounded-lg overflow-hidden">
            <!-- Success animation header -->
            <div class="relative flex flex-col items-center justify-center py-8 sm:py-10 bg-bg-surface">
              <!-- Success icon with glow -->
              <div class="relative">
                <div class="absolute inset-0 bg-green-500/20 rounded-full blur-xl animate-pulse"></div>
                <div class="relative w-16 h-16 sm:w-20 sm:h-20 rounded-full bg-green-500/10 border-2 border-green-500/50 flex items-center justify-center">
                  <svg
                    class="text-green-500 w-8 h-8 sm:w-10 sm:h-10 animate-success-check"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <polyline points="20 6 9 17 4 12"></polyline>
                  </svg>
                </div>
              </div>

              <!-- Celebratory pixels -->
              <div class="success-pixels absolute inset-0 pointer-events-none overflow-hidden">
                <div class="success-pixel" style="--x: 20%; --delay: 0.1s"></div>
                <div class="success-pixel" style="--x: 40%; --delay: 0.2s"></div>
                <div class="success-pixel" style="--x: 60%; --delay: 0.15s"></div>
                <div class="success-pixel" style="--x: 80%; --delay: 0.25s"></div>
                <div class="success-pixel" style="--x: 30%; --delay: 0.3s"></div>
                <div class="success-pixel" style="--x: 70%; --delay: 0.05s"></div>
              </div>
            </div>

            <!-- Success content -->
            <div class="p-5 sm:p-6 text-center">
              <h3 class="text-green-400 mb-2 font-mono text-lg sm:text-xl font-bold uppercase tracking-wide">
                ¡Imagen guardada!
              </h3>
              <p class="text-text/60 mb-5 font-mono text-sm">
                Tu pixel art ya está en la blockchain de Hive
              </p>

              <!-- Transaction info -->
              <div class="bg-black/30 rounded-lg p-3 mb-5">
                <p class="font-mono text-[10px] uppercase tracking-wider text-text/40 mb-1">Transaction ID</p>
                <p id="tx-id-display" class="font-mono text-xs text-text/70 break-all"></p>
              </div>

              <!-- Action buttons -->
              <div class="flex flex-col sm:flex-row gap-3">
                <a
                  id="view-image-link"
                  href="/"
                  class="flex-1 inline-flex items-center justify-center gap-2 px-5 py-3 bg-accent text-white font-mono text-xs uppercase tracking-wider rounded hover:bg-accent/90 transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-accent focus-visible:ring-offset-2 focus-visible:ring-offset-black"
                >
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                  Ver imagen
                </a>
                <button
                  id="upload-another-btn"
                  type="button"
                  class="flex-1 inline-flex items-center justify-center gap-2 px-5 py-3 border border-text/20 text-text/70 font-mono text-xs uppercase tracking-wider rounded hover:border-text/40 hover:text-text transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-text/50"
                >
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  Subir otra
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  /* Pixel loader for processing */
  .pixel-loader {
    width: 60px;
    height: 60px;
  }

  .pixel-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    width: 100%;
    height: 100%;
  }

  .pixel {
    background-color: var(--color-accent);
    animation: pixel-pulse 1.2s ease-in-out infinite;
  }

  .pixel:nth-child(1) { animation-delay: 0s; }
  .pixel:nth-child(2) { animation-delay: 0.1s; }
  .pixel:nth-child(3) { animation-delay: 0.2s; }
  .pixel:nth-child(4) { animation-delay: 0.3s; }
  .pixel:nth-child(5) { animation-delay: 0.4s; }
  .pixel:nth-child(6) { animation-delay: 0.5s; }
  .pixel:nth-child(7) { animation-delay: 0.6s; }
  .pixel:nth-child(8) { animation-delay: 0.7s; }
  .pixel:nth-child(9) { animation-delay: 0.8s; }

  @keyframes pixel-pulse {
    0%, 100% { opacity: 0.2; transform: scale(0.8); }
    50% { opacity: 1; transform: scale(1); }
  }

  /* Upload progress pixel animation */
  .upload-pixel-loader {
    width: 48px;
    height: 48px;
  }

  .upload-pixel-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 3px;
    width: 100%;
    height: 100%;
  }

  .upload-pixel {
    background-color: var(--color-accent);
    animation: upload-pixel-wave 1.5s ease-in-out infinite;
    animation-delay: calc(var(--delay) * 0.1s);
  }

  @keyframes upload-pixel-wave {
    0%, 100% { opacity: 0.15; transform: scale(0.7); }
    50% { opacity: 1; transform: scale(1); background-color: #fff; }
  }

  /* Progress bar shimmer */
  @keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
  }

  .animate-shimmer {
    animation: shimmer 2s infinite;
  }

  /* Success check animation */
  @keyframes success-check {
    0% { stroke-dashoffset: 24; opacity: 0; }
    50% { opacity: 1; }
    100% { stroke-dashoffset: 0; opacity: 1; }
  }

  .animate-success-check {
    stroke-dasharray: 24;
    animation: success-check 0.5s ease-out forwards;
  }

  /* Success celebration pixels */
  .success-pixel {
    position: absolute;
    width: 6px;
    height: 6px;
    background: var(--color-accent);
    left: var(--x);
    bottom: 0;
    animation: success-pixel-rise 1.5s ease-out infinite;
    animation-delay: var(--delay);
  }

  @keyframes success-pixel-rise {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-100px) scale(0.5); opacity: 0; }
  }

</style>

<script>
  import { getLoggedUser } from "@/lib/auth";
  import { AUTH_STORAGE_KEY, MAX_FRAGMENT_SIZE } from "@/lib/constants";
  import {
    processImage,
    formatBytes,
    isValidFormat,
    type ProcessedImage,
  } from "@/lib/image-processor";
  import {
    uploadImage,
    isKeychainAvailable,
    type BroadcastProgress,
  } from "@/lib/broadcast";

  // DOM elements
  const authRequired = document.getElementById("auth-required");
  const uploadInterface = document.getElementById("upload-interface");
  const dropZone = document.getElementById("drop-zone");
  const fileInput = document.getElementById("file-input") as HTMLInputElement;
  const loadingContainer = document.getElementById("loading-container");
  const errorContainer = document.getElementById("error-container");
  const errorMessage = document.getElementById("error-message");
  const retryBtn = document.getElementById("retry-btn");
  const previewContainer = document.getElementById("preview-container");
  const previewWrapper = document.getElementById("preview-wrapper");
  const previewImage = document.getElementById("preview-image") as HTMLImageElement;
  const fileNameEl = document.getElementById("file-name");
  const dimensionsEl = document.getElementById("dimensions");
  const fileSizeEl = document.getElementById("file-size");
  const fragmentCountEl = document.getElementById("fragment-count");
  const aspectRatioEl = document.getElementById("aspect-ratio");
  const cancelBtn = document.getElementById("cancel-btn");
  const uploadBtn = document.getElementById("upload-btn") as HTMLButtonElement;
  const viewLink = document.getElementById("view-image-link") as HTMLAnchorElement;

  // Modal elements
  const imageModal = document.getElementById("image-modal");
  const modalBackdrop = document.getElementById("modal-backdrop");
  const modalCloseBtn = document.getElementById("modal-close-btn");
  const modalImage = document.getElementById("modal-image") as HTMLImageElement;
  const modalImageWrapper = document.getElementById("modal-image-wrapper");
  const modalDimensions = document.getElementById("modal-dimensions");
  const previewZoomBtn = document.getElementById("preview-zoom-btn");

  // Progress elements
  const progressContainer = document.getElementById("progress-container");
  const progressText = document.getElementById("progress-text");
  const progressBar = document.getElementById("progress-bar");
  const progressStatus = document.getElementById("progress-status");

  // Success elements
  const successContainer = document.getElementById("success-container");
  const txIdDisplay = document.getElementById("tx-id-display");
  const uploadAnotherBtn = document.getElementById("upload-another-btn");

  let processedImage: ProcessedImage | null = null;
  let isUploading = false;
  let lastUploadResult: { imageId: string; txId: string } | null = null;

  function updateAuthUI() {
    const username = getLoggedUser();

    if (username) {
      authRequired?.classList.add("hidden");
      uploadInterface?.classList.remove("hidden");
      if (viewLink) {
        viewLink.setAttribute("href", `/@${username}`);
      }
    } else {
      authRequired?.classList.remove("hidden");
      uploadInterface?.classList.add("hidden");
    }
  }

  function hideAllContainers() {
    dropZone?.classList.add("hidden");
    loadingContainer?.classList.add("hidden");
    errorContainer?.classList.add("hidden");
    previewContainer?.classList.add("hidden");
    progressContainer?.classList.add("hidden");
    successContainer?.classList.add("hidden");
  }

  function showDropZone() {
    hideAllContainers();
    dropZone?.classList.remove("hidden");
  }

  function showLoading() {
    hideAllContainers();
    loadingContainer?.classList.remove("hidden");
  }

  function showError(message: string) {
    hideAllContainers();
    errorContainer?.classList.remove("hidden");
    if (errorMessage) errorMessage.textContent = message;
  }

  function showPreview(result: ProcessedImage, fileName: string) {
    hideAllContainers();
    previewContainer?.classList.remove("hidden");

    // Calculate display size maintaining aspect ratio
    // Scale up larger for prominent display (mobile-first)
    const containerMaxWidth = Math.min(window.innerWidth - 80, 480);
    const containerMaxHeight = 300;

    const scaleX = containerMaxWidth / result.width;
    const scaleY = containerMaxHeight / result.height;
    const scale = Math.min(scaleX, scaleY, 6); // Max 6x for crisp pixel art

    const displayWidth = Math.round(result.width * scale);
    const displayHeight = Math.round(result.height * scale);

    if (previewImage) {
      previewImage.src = result.dataUrl;
      previewImage.style.width = `${displayWidth}px`;
      previewImage.style.height = `${displayHeight}px`;
    }

    // Update modal image with proper aspect ratio
    if (modalImage && modalImageWrapper) {
      modalImage.src = result.dataUrl;
      // Scale for modal: fit within viewport while preserving aspect ratio
      const modalMaxWidth = Math.min(window.innerWidth * 0.9, 700);
      const modalMaxHeight = window.innerHeight * 0.75;
      const modalScaleX = modalMaxWidth / result.width;
      const modalScaleY = modalMaxHeight / result.height;
      const modalScale = Math.min(modalScaleX, modalScaleY, 10); // Max 10x for modal

      const modalWidth = Math.round(result.width * modalScale);
      const modalHeight = Math.round(result.height * modalScale);

      modalImage.style.width = `${modalWidth}px`;
      modalImage.style.height = `${modalHeight}px`;
    }

    // Calculate fragment count
    const fragmentCount = Math.ceil(result.base64Size / MAX_FRAGMENT_SIZE);

    // Update all info fields
    if (fileNameEl) fileNameEl.textContent = fileName;
    if (dimensionsEl) dimensionsEl.textContent = `${result.width}×${result.height}`;
    if (fileSizeEl) fileSizeEl.textContent = formatBytes(result.base64Size);
    if (fragmentCountEl) fragmentCountEl.textContent = `${fragmentCount} ops`;
    if (aspectRatioEl) aspectRatioEl.textContent = result.aspectRatio.label;
    if (modalDimensions) modalDimensions.textContent = `${result.width}×${result.height} · ${formatBytes(result.base64Size)} · ${fragmentCount} fragmentos`;
  }

  function openModal() {
    imageModal?.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    imageModal?.classList.add("hidden");
    document.body.style.overflow = "";
  }

  function showProgress(progress: BroadcastProgress) {
    hideAllContainers();
    progressContainer?.classList.remove("hidden");

    if (progressText) {
      progressText.textContent = `${progress.current}/${progress.total}`;
    }

    if (progressBar) {
      const percent = (progress.current / progress.total) * 100;
      progressBar.style.width = `${percent}%`;
    }

    if (progressStatus) {
      progressStatus.textContent = progress.message;
    }
  }

  function showSuccess(imageId: string, transactionId: string) {
    hideAllContainers();
    successContainer?.classList.remove("hidden");

    // Store for potential use
    lastUploadResult = { imageId, txId: transactionId };

    // Update transaction ID display
    if (txIdDisplay) {
      txIdDisplay.textContent = transactionId;
    }

    // Update view link to point to the image using txid
    if (viewLink) {
      viewLink.href = `/image/${transactionId}`;
    }
  }

  async function handleFile(file: File) {
    if (!isValidFormat(file.type)) {
      showError("Formato no compatible. Usa PNG, JPEG o WebP");
      return;
    }

    showLoading();

    try {
      const result = await processImage(file);
      processedImage = result;
      showPreview(result, file.name);
    } catch (error) {
      showError(
        error instanceof Error ? error.message : "Error al procesar la imagen",
      );
    }
  }

  async function handleUpload() {
    if (!processedImage || isUploading) return;

    const username = getLoggedUser();
    if (!username) {
      showError("Debes iniciar sesión para subir imágenes");
      return;
    }

    // Check Keychain
    const keychainAvailable = isKeychainAvailable();
    if (!keychainAvailable) {
      showError(
        "Hive Keychain no está instalado. Descárgalo en hive-keychain.com",
      );
      return;
    }

    isUploading = true;
    uploadBtn.disabled = true;

    try {
      const result = await uploadImage(processedImage, username, showProgress);

      if (result.success) {
        // Get the transaction ID from the first successful result
        const firstSuccessResult = result.results.find(r => r.success);
        const txId = firstSuccessResult && 'transactionId' in firstSuccessResult
          ? firstSuccessResult.transactionId
          : 'unknown';

        showSuccess(result.imageId, txId);
        processedImage = null;
      } else {
        showError(result.error || "Error al subir la imagen");
      }
    } catch (error) {
      showError(error instanceof Error ? error.message : "Error inesperado");
    } finally {
      isUploading = false;
      uploadBtn.disabled = false;
    }
  }

  function resetUpload() {
    processedImage = null;
    isUploading = false;
    if (fileInput) fileInput.value = "";
    showDropZone();
  }

  // Initialize
  document.addEventListener("DOMContentLoaded", () => {
    updateAuthUI();

    // Listen for auth changes
    window.addEventListener("storage", (e) => {
      if (e.key === AUTH_STORAGE_KEY) updateAuthUI();
    });

    // Check auth periodically (for same-tab changes)
    const checkAuth = setInterval(updateAuthUI, 500);
    setTimeout(() => clearInterval(checkAuth), 10000);

    // File input
    fileInput?.addEventListener("change", (e) => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (file) handleFile(file);
    });

    // Drag and drop
    dropZone?.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropZone.classList.add("border-accent");
    });

    dropZone?.addEventListener("dragleave", () => {
      dropZone.classList.remove("border-accent");
    });

    dropZone?.addEventListener("drop", (e) => {
      e.preventDefault();
      dropZone.classList.remove("border-accent");
      const file = e.dataTransfer?.files?.[0];
      if (file) handleFile(file);
    });

    // Retry button
    retryBtn?.addEventListener("click", resetUpload);

    // Cancel button
    cancelBtn?.addEventListener("click", resetUpload);

    // Upload button
    uploadBtn?.addEventListener("click", handleUpload);

    // Modal controls
    previewZoomBtn?.addEventListener("click", openModal);
    modalCloseBtn?.addEventListener("click", closeModal);
    modalBackdrop?.addEventListener("click", closeModal);

    // Upload another button
    uploadAnotherBtn?.addEventListener("click", () => {
      lastUploadResult = null;
      resetUpload();
    });

    // Close modal with Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !imageModal?.classList.contains("hidden")) {
        closeModal();
      }
    });

    // Handle keyboard activation of drop zone
    dropZone?.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        fileInput?.click();
      }
    });
  });
</script>
